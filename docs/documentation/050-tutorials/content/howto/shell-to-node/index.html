<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta name=copyright content="Copyright 2019 Gardener project authors."><title>Get a Shell to a Gardener Shoot Worker Node :: Gardener</title><link rel=icon type=image/x-icon href=https://gardener.cloud/images/favicon.ico><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-16x16.png sizes=16x16><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-W2FGNSX');</script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-165447164-1');</script><link href=/css/nucleus.css?1589917624 rel=stylesheet><link href=/css/fontawesome-all.min.css?1589917624 rel=stylesheet><link href=/css/hybrid.css?1589917624 rel=stylesheet><link href=/css/featherlight.min.css?1589917624 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1589917624 rel=stylesheet><link href=/css/auto-complete.css?1589917624 rel=stylesheet><link href=/css/skeleton.css?1589917624 rel=stylesheet><link href=/css/sheetslider.css?1589917624 rel=stylesheet><script src=/js/moment.js?1589917624></script><script src=/js/vivus.js?1589917624></script><script src=/js/scrollreveal.js?1589917624></script><script src=/js/inlineSVG.js?1589917624></script><link href=/css/theme.css?1589917624 rel=stylesheet><link href=/css/hugo-theme.css?1589917624 rel=stylesheet><link href=/css/theme-docs-gardener.css?1589917624 rel=stylesheet><script src=/js/jquery-2.x.min.js?1589917624></script><script src=/js/fixed.js?1589917624></script><style type=text/css>:root #header+#content>#left>#rlblock_left{display:none!important}</style><link rel=stylesheet href=/css/base.719d15e30b8f7c063ceed818b86f5be2ae7830ba8c1fb0ae9f0dd21e189a7ec1.css></head><body data-url=/documentation/050-tutorials/content/howto/shell-to-node/><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W2FGNSX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=https://gardener.cloud/><svg width="90" height="90" viewBox="0 0 90 90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>logo</title><defs><path d="M41.8864954.994901575C42.8830405.514990742 44.5028956.516982644 45.4953045.994901575L76.8159138 16.0781121C77.8124589 16.5580229 78.8208647 17.8257185 79.0659694 18.8995926L86.8015211 52.7912589C87.0476474 53.8696088 86.6852538 55.4484075 85.9984855 56.3095876L64.3239514 83.4885938C63.6343208 84.3533632 62.1740175 85.0543973 61.0725268 85.0543973H26.3092731C25.2031915 85.0543973 23.7446167 84.3497739 23.0578485 83.4885938L1.38331434 56.3095876C.693683723 55.4448182.335174016 53.865133.580278769 52.7912589L8.31583044 18.8995926C8.56195675 17.8212428 9.57347722 16.556031 10.5658861 16.0781121L41.8864954.994901575z" id="path-1"/><linearGradient x1="12.7542673%" y1="-18.6617048%" x2="88.2666158%" y2="84.6075483%" id="linearGradient-3"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="50%" y1="4.93673768%" x2="148.756007%" y2="175.514523%" id="linearGradient-4"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="19.1574381%" y1="-9.04800713%" x2="82.2203149%" y2="77.9084293%" id="linearGradient-5"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient><linearGradient x1="57.4403751%" y1="26.3148481%" x2="137.966711%" y2="158.080556%" id="linearGradient-6"><stop stop-color="#fff" offset="0"/><stop stop-color="#439246" offset="100%"/></linearGradient></defs><g id="logo" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Rectangle-2" transform="translate(1.000000, 0.000000)"><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Mask" fill="#009f76" xlink:href="#path-1"/><polygon fill="#000" opacity=".289628623" mask="url(#mask-2)" points="-17.6484375 54.5224609 30.8242188 25.0791016 63.4726562 58.5 24.7324219 92.6689453"/></g><path d="M56.8508631 39.260019C56.4193519 40.443987 55.6088085 41.581593 54.6736295 42.1938694L46.5997298 47.4799783C45.2142627 48.3870654 42.9749783 48.3916494 41.5825097 47.4799783L33.50861 42.1938694C32.123143 41.2867823 31 39.206345 31 37.545932V26.4150304C31 25.6897174 31.2131118 24.884885 31.5692681 24.1324532L56.8508631 39.260019z" id="Combined-Shape" fill="url(#linearGradient-3)" transform="translate(43.925432, 36.147233) scale(-1, 1) translate(-43.925432, -36.147233)"/><path d="M56.0774672 25.1412464C56.4306829 25.8903325 56.6425556 26.6907345 56.6425556 27.4119019V38.5428034C56.6425556 40.2027013 55.5264141 42.2790698 54.1339456 43.1907408L46.0600459 48.4768498C44.6745788 49.3839368 42.4352943 49.3885208 41.0428258 48.4768498L32.9689261 43.1907408C32.2918101 42.7474223 31.6773514 42.0238435 31.2260376 41.206007L56.0774672 25.1412464z" id="Combined-Shape" fill="url(#linearGradient-4)" transform="translate(43.821278, 37.246598) scale(-1, 1) translate(-43.821278, -37.246598)"/><path d="M65.0702134 57.1846889C64.5985426 58.2007851 63.8367404 59.1236871 62.9788591 59.6189851L47.37497 68.6278947C45.9443535 69.4538615 43.6226022 69.4525546 42.1942494 68.6278947L26.5903603 59.6189851C25.1597438 58.7930183 24 56.7816693 24 55.1323495V37.1145303C24 36.3487436 24.249712 35.5060005 24.6599102 34.7400631L65.0702134 57.1846889z" id="Combined-Shape" fill="url(#linearGradient-5)"/><path d="M65.0189476 34.954538C65.3636909 35.6617313 65.5692194 36.42021 65.5692194 37.1145303V55.1323495C65.5692194 56.7842831 64.4072119 58.7943252 62.9788591 59.6189851L47.37497 68.6278947C45.9443535 69.4538615 43.6226022 69.4525546 42.1942494 68.6278947L26.5903603 59.6189851C25.9237304 59.2341061 25.3159155 58.5918431 24.8568495 57.8487596L65.0189476 34.954538z" id="Combined-Shape" fill="url(#linearGradient-6)"/></g></svg><h1>Gardener</h1><h2>Universal Kubernetes at Scale</h2></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=text placeholder=Search...>
<span data-search-clear><i class="fas fa-close"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1589917624></script><script type=text/javascript src=/js/auto-complete.js?1589917624></script><script type=text/javascript>var baseurl='\/';</script><script type=text/javascript src=/js/search.js?1589917624></script></div><div class=highlightable><ul class=topics><li data-nav-id=/documentation/ title=Documentations class="dd-item
parent"><a href=/documentation/>Documentations</a><ul><li data-nav-id=/about/ title="Getting Started" class=dd-item><a href=/about/><img class=navigation-icon src=https://gardener.cloud/images/navigation_started.svg>
Getting Started</a></li><li data-nav-id=/documentation/030-architecture/ title=Architecture class=dd-item><a href=/documentation/030-architecture/><img class=navigation-icon src=https://gardener.cloud/images/navigation_architecture.svg>
Architecture</a><ul><li data-nav-id=/components/gardener/ title=Gardener class=dd-item><a href=/components/gardener/>Gardener</a></li><li data-nav-id=/components/gardenctl/ title=gardenctl class=dd-item><a href=/components/gardenctl/>gardenctl</a></li><li data-nav-id=/components/mcm/ title="Machine Controller Manager" class=dd-item><a href=/components/mcm/>Machine Controller Manager</a></li><li data-nav-id=/components/cert-broker/ title="Cert Broker" class=dd-item><a href=/components/cert-broker/>Cert Broker</a></li><li data-nav-id=/components/dns-cm/ title="DNS Controller Manager" class=dd-item><a href=/components/dns-cm/>DNS Controller Manager</a></li><li data-nav-id=/components/dashboard/ title=Dashboard class=dd-item><a href=/components/dashboard/>Dashboard</a></li><li data-nav-id=/components/kubify/ title=kubify class=dd-item><a href=/components/kubify/>kubify</a></li><li data-nav-id=/components/bouquet/ title=Bouquet class=dd-item><a href=/components/bouquet/>Bouquet</a></li></ul></li><li data-nav-id=/contribute/ title=Contribute class=dd-item><a href=/contribute/><img class=navigation-icon src=https://gardener.cloud/images/navigation_contribute.svg>
Contribute</a><ul><li data-nav-id=/contribute/code/ title=Code class=dd-item><a href=/contribute/code/>Code</a><ul><li data-nav-id=/documentation/045_contribute/10_code/10-contribution_guide/ title="Contribution Guide" class=dd-item><a href=/documentation/045_contribute/10_code/10-contribution_guide/>Contribution Guide</a></li><li data-nav-id=/documentation/045_contribute/10_code/12-security_guide/ title="Security Release Process" class=dd-item><a href=/documentation/045_contribute/10_code/12-security_guide/>Security Release Process</a></li><li data-nav-id=/documentation/045_contribute/10_code/13_env/ title=Enviroment class=dd-item><a href=/documentation/045_contribute/10_code/13_env/>Enviroment</a></li><li data-nav-id=/documentation/045_contribute/10_code/14_cicd/ title=CI/CD class=dd-item><a href=/documentation/045_contribute/10_code/14_cicd/>CI/CD</a></li><li data-nav-id=/documentation/045_contribute/10_code/15_conf_secrets/ title="Configuration and Usage" class=dd-item><a href=/documentation/045_contribute/10_code/15_conf_secrets/>Configuration and Usage</a></li><li data-nav-id=/documentation/045_contribute/10_code/20_dependencies/ title=Dependencies class=dd-item><a href=/documentation/045_contribute/10_code/20_dependencies/>Dependencies</a></li><li data-nav-id=/documentation/045_contribute/10_code/27_deploy_into_cluster/ title="Deploy into a Cluster" class=dd-item><a href=/documentation/045_contribute/10_code/27_deploy_into_cluster/>Deploy into a Cluster</a></li><li data-nav-id=/documentation/045_contribute/10_code/30_deploy_seed_into_aks/ title="Deploy into AKS" class=dd-item><a href=/documentation/045_contribute/10_code/30_deploy_seed_into_aks/>Deploy into AKS</a></li><li data-nav-id=/documentation/045_contribute/10_code/37_process/ title=Process class=dd-item><a href=/documentation/045_contribute/10_code/37_process/>Process</a></li><li data-nav-id=/documentation/045_contribute/10_code/40_repositories/ title=Repositories class=dd-item><a href=/documentation/045_contribute/10_code/40_repositories/>Repositories</a></li></ul></li><li data-nav-id=/contribute/docs/ title=Documentation class=dd-item><a href=/contribute/docs/>Documentation</a><ul><li data-nav-id=/documentation/045_contribute/20_documentation/10_organisation/ title=Organisation class=dd-item><a href=/documentation/045_contribute/20_documentation/10_organisation/>Organisation</a></li><li data-nav-id=/documentation/045_contribute/20_documentation/20_style/ title="Style Guide" class=dd-item><a href=/documentation/045_contribute/20_documentation/20_style/>Style Guide</a></li><li data-nav-id=/documentation/045_contribute/20_documentation/25_markup/ title=Markdown class=dd-item><a href=/documentation/045_contribute/20_documentation/25_markup/>Markdown</a><ul><li data-nav-id=/documentation/045_contribute/20_documentation/25_markup/attachments/ title=Attachments class=dd-item><a href=/documentation/045_contribute/20_documentation/25_markup/attachments/>Attachments</a></li><li data-nav-id=/documentation/045_contribute/20_documentation/25_markup/button/ title=Button class=dd-item><a href=/documentation/045_contribute/20_documentation/25_markup/button/>Button</a></li><li data-nav-id=/documentation/045_contribute/20_documentation/25_markup/expand/ title=Expand class=dd-item><a href=/documentation/045_contribute/20_documentation/25_markup/expand/>Expand</a></li><li data-nav-id=/documentation/045_contribute/20_documentation/25_markup/mermaid/ title=Mermaid class=dd-item><a href=/documentation/045_contribute/20_documentation/25_markup/mermaid/>Mermaid</a></li><li data-nav-id=/documentation/045_contribute/20_documentation/25_markup/notice/ title=Notice class=dd-item><a href=/documentation/045_contribute/20_documentation/25_markup/notice/>Notice</a></li></ul></li></ul></li></ul></li><li data-nav-id=/tutorials/ title=Tutorials class="dd-item
parent"><a href=/tutorials/><img class=navigation-icon src=https://gardener.cloud/images/navigation_tutorials.svg>
Tutorials</a><ul><li data-nav-id=/using-gardener/administrator/ title=Administrator class=dd-item><a href=/using-gardener/administrator/>Administrator</a></li><li data-nav-id=/using-gardener/developer/topic/ title="App Developer" class=dd-item><a href=/using-gardener/developer/topic/>App Developer</a></li></ul></li><li data-nav-id=/curated-links/ title="Curated Links" class=dd-item><a href=/curated-links/><img class=navigation-icon src=https://gardener.cloud/images/navigation_links.svg>
Curated Links</a></li><li data-nav-id=/api-reference/ title="API Reference" class=dd-item><a href=/api-reference/><img class=navigation-icon src=https://gardener.cloud/images/navigation_tutorials.svg>
API Reference</a><ul><li data-nav-id=/api-reference/core/ title=Core class=dd-item><a href=/api-reference/core/>Core</a></li><li data-nav-id=/api-reference/extensions/ title=Extensions class=dd-item><a href=/api-reference/extensions/>Extensions</a></li><li data-nav-id=/api-reference/settings/ title=Settings class=dd-item><a href=/api-reference/settings/>Settings</a></li></ul></li></ul></li><li data-nav-id=/adopter/ title=Adopters class=dd-item><a href=/adopter/>Adopters</a></li><li data-nav-id=/blog/ title=Blogs class=dd-item><a href=/blog/>Blogs</a></li><li data-nav-id=/community/ title=Community class=dd-item><a href=/community/>Community</a></li><li data-nav-id=/installer/ class=dd-item><a href=/installer/></a></li><li data-nav-id=/news/ title=News class=dd-item></li></ul><section id=footer><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable body-inner-wrapper"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/gardener/documentation/edit/master/website/documentation/050-tutorials/content/howto/shell-to-node/_index.md target=blank><i class="fa fa-code-fork"></i><span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fa fa-bars"></i></a></span><span id=toc-menu><i class="fa fa-list-alt"></i></span><span class=links><a href=/>Gardener</a> > <a href=/documentation/>Documentations</a> > <a href=/tutorials/>Tutorials</a> > Get a Shell to a Gardener Shoot Worker Node</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#gardener-dashboard>Gardener Dashboard</a></li><li><a href=#gardenctl-shell>gardenctl shell</a></li><li><a href=#gardener-ops-toolbelt>Gardener Ops Toolbelt</a></li><li><a href=#custom-root-pod>Custom root pod</a></li></ul><ul><li><a href=#identifying-the-problematic-instance>Identifying the problematic instance</a></li><li><a href=#gardenctl-ssh>gardenctl ssh</a></li><li><a href=#ssh-with-manually-created-bastion-on-aws>SSH with manually created Bastion on AWS</a><ul><li><a href=#create-the-bastion-security-group>Create the Bastion Security Group</a></li><li><a href=#create-the-bastion-instance>Create the bastion instance</a></li></ul></li><li><a href=#connecting-to-the-target-instance>Connecting to the target instance</a></li><li><a href=#cleanup>Cleanup</a></li></ul></nav></div></div></div></div><div class=tutorial-last-update>Updated <span><span data-publishdate=2020-05-12T10:24:25Z></span></span>by <a href=mailto:daniel.foehr@sap.com>d060239</a></div><div id=body-inner><h1 id=get-a-shell-to-a-kubernetes-node>Get a Shell to a Kubernetes Node</h1><p>To troubleshoot certain problems in a Kubernetes cluster, operators need access to the host of the Kubernetes node to troubleshoot
problems. This can be required if a node misbehaves or fails to join the cluster in the first place.</p><p>With access to the host, it is for instance possible to check the <code>kubelet</code> logs and interact with common tools such as <code>systemctl</code>and <code>journalctl</code>.</p><p>The first section of this guide explores options to get a shell to the node of a Gardener Kubernetes cluster.
The options described in the second section do not rely on Kubernetes capabilities to get shell access to a node and thus can also be used if an instance failed to join the cluster.</p><p>This guide only covers how to get access to the host, but does not cover troubleshooting methods.</p><ul><li><a href=#get-a-shell-to-an-operational-cluster-node>Get a Shell to an operational cluster node</a><ul><li><a href=#gardener-dashboard>Gardener Dashboard</a></li><li><a href=#gardenctl-shell>gardenctl shell</a></li><li><a href=#gardener-ops-toolbelt>Gardener Ops Toolbelt</a></li><li><a href=#custom-root-pod>Custom root pod</a></li></ul></li><li><a href=#ssh-access-to-a-node-that-failed-to-join-the-cluster>SSH access to a node that failed to join the cluster</a><ul><li><a href=#gardenctl-ssh>gardenctl-ssh</a></li><li><a href=#ssh-with-manually-created-bastion-on-aws>SSH with manually created Bastion on AWS</a></li></ul></li></ul><h1 id=get-a-shell-to-an-operational-cluster-node>Get a Shell to an operational cluster node</h1><p>The following describes four different approaches to get a shell to an operational Shoot worker node.
As a prerequisite to troubleshooting a Kubernetes node, the node must have joined the cluster successfully and be able to run a pod.
All of the described approaches involve scheduling a pod with root permissions and mounting the root filesystem.</p><h2 id=gardener-dashboard>Gardener Dashboard</h2><p><strong>Prerequisite</strong>: the terminal feature is configured for the Gardener dashboard.</p><p>Navigate to the cluster overview page and find the <code>Terminal</code> in the <code>Access</code> tile.</p><img style=margin-left:0;width:80%;height:auto alt="Access Tile" src=resources/9fb6ca4ff9b7480f93debba833f48590.png><br><p>Select the target Cluster (Garden, Seed / Control Plane, Shoot cluster) depending on the requirements and
access rights (only certain users have access to the Seed Control Plane).</p><p>To open the terminal configuration, click on the top right-hand corner of the screen.</p><img style=margin-left:0 alt="Terminal configuration" src=resources/db573582bfc544d294cbde8906a74e07.png><br><p>Set the Terminal Runtime to &ldquo;Privileged.
Also specify the target node from the drop-down menu.</p><img style=margin-left:0;width:50%;height:auto alt="Dashboard terminal pod configuration" src=resources/f7b10d48edf44c17ba838ff5c429e39d.png><br><p>The dashboard then schedules a pod and opens a shell session to the node.</p><p>To get access to common binaries installed on the host, prefix the command with <code>chroot /hostroot</code>.
Note that the path depends on where the root path is mounted in the container.
In the default image used by the Dashboard, it is under <code>/hostroot</code>.</p><img style=margin-left:0 alt="Dashboard terminal pod configuration" src=resources/3da659e9cc4744a2ad3e1c6a50d39c04.png><br><h2 id=gardenctl-shell>gardenctl shell</h2><p><strong>Prerequisite</strong>: <code>kubectl</code> and <a href=https://github.com/gardener/gardenctl>gardenctl are available and configured</a>.</p><p>First, target a Garden cluster containing all the Shoot definitions.</p><pre><code>$ gardenctl target garden &lt;target-garden&gt;
</code></pre><p>Target an available Shoot by name.
This sets up the context and configures the <code>kubeconfig</code> file of the Shoot cluster.
Subsequent commands will execute in this context.</p><pre><code>$ gardenctl target shoot &lt;target-shoot&gt;
</code></pre><p>Get the nodes of the Shoot cluster.</p><pre><code>$ gardenctl kubectl get nodes 
</code></pre><p>Pick a node name from the list above and get a root shell access to it.</p><pre><code>$ gardenctl shell &lt;target-node&gt;
</code></pre><h2 id=gardener-ops-toolbelt>Gardener Ops Toolbelt</h2><p><strong>Prerequisite</strong>: <code>kubectl</code> is available.</p><p>The <a href=https://github.com/gardener/ops-toolbelt>Gardener ops-toolbelt</a> can be used as a convenient way to deploy a root pod to a node.
The pod uses an image that is bundled with a bunch of useful <a href=https://github.com/gardener/ops-toolbelt/tree/master/dockerfile-configs>troubleshooting tools</a>.
This is also the same image that is used by default when using the Gardener Dashboard terminal feature as described in the <a href=#gardener-dashboard>previous section</a>.</p><p>The easiest way to use the <a href=https://github.com/gardener/ops-toolbelt>Gardener ops-toolbelt</a> is to execute
the <a href=https://github.com/gardener/ops-toolbelt/blob/master/hacks/ops-pod><code>ops-pod</code> script</a> in the <code>hacks</code> folder.
To get root shell access to a node, execute the aforementioned script by supplying the target node name as an argument:</p><pre><code>$ &lt;path-to-ops-toolbelt-repo&gt;/hacks/ops-pod &lt;target-node&gt;
</code></pre><h2 id=custom-root-pod>Custom root pod</h2><p>Alternatively, a pod can be <a href=https://kubernetes.io/docs/concepts/configuration/assign-pod-node/>assigned</a> to a target node and a shell can
be opened via <a href=https://kubernetes.io/docs/tasks/debug-application-cluster/get-shell-running-container/>standard Kubernetes means</a>.
To enable root access to the node, the pod specification requires proper <code>securityContext</code> and <code>volume</code> properties.</p><p>For instance you can use the following pod manifest, after changing <target-node-name>with the name of the node you want this pod attached to:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: v1
<span style=color:#66d9ef>kind</span>: Pod
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: privileged-pod
  <span style=color:#66d9ef>namespace</span>: default
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>nodeSelector</span>:
    <span style=color:#66d9ef>kubernetes.io/hostname</span>: &lt;target-node-name<span style=color:#e6db74>&gt;
</span><span style=color:#e6db74>  containers:</span>
  - <span style=color:#66d9ef>name</span>: busybox
    <span style=color:#66d9ef>image</span>: busybox
    <span style=color:#66d9ef>stdin</span>: <span style=color:#66d9ef>true</span>
    <span style=color:#66d9ef>securityContext</span>:
      <span style=color:#66d9ef>privileged</span>: <span style=color:#66d9ef>true</span>
    <span style=color:#66d9ef>volumeMounts</span>:
    - <span style=color:#66d9ef>name</span>: host-root-volume
      <span style=color:#66d9ef>mountPath</span>: /host
      <span style=color:#66d9ef>readOnly</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>volumes</span>:
  - <span style=color:#66d9ef>name</span>: host-root-volume
    <span style=color:#66d9ef>hostPath</span>:
      <span style=color:#66d9ef>path</span>: /
  <span style=color:#66d9ef>hostNetwork</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>hostPID</span>: <span style=color:#66d9ef>true</span>
  <span style=color:#66d9ef>restartPolicy</span>: Never
</code></pre></div><h1 id=ssh-access-to-a-node-that-failed-to-join-the-cluster>SSH access to a node that failed to join the cluster</h1><p>This section explores two options that can be used to get SSH access to a node that failed to join the cluster.
As it is not possible to schedule a pod on the node, the Kubernetes-based methods explored so far cannot be used in this scenario.</p><p>Additionally, Gardener typically provisions worker instances in a private subnet of the VPC, hence - there is no public IP address that could be used for direct SSH access.</p><p>For this scenario, cloud providers typically have extensive documentation (e.g <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html>AWS</a> & <a href=https://cloud.google.com/compute/docs/instances/connecting-to-instance>GCP</a>
and in <a href=https://cloud.google.com/compute/docs/instances/connecting-advanced#vpn>some cases tooling support</a>).
However, these approaches are mostly cloud provider specific, require interaction via their CLI and API or sometimes
the installation of a <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-install-ssm-agent.html>cloud provider specific agent</a> one the node.</p><p>Alternatively, <code>gardenctl</code> can be used providing a cloud provider agnostic and out-of-the-box support to get ssh access to an instance in a private subnet.
Currently <code>gardenctl</code> supports AWS, GCP, Openstack, Azure and Alibaba Cloud.</p><h2 id=identifying-the-problematic-instance>Identifying the problematic instance</h2><p>First, the problematic instance has to be identified.
In Gardener, worker pools can be created in different cloud provider regions, zones and accounts.</p><p>The instance would typically show up as successfully started / running in the cloud provider dashboard or API and it is not immediately obvious which one has a problem.
Instead, we can use the Gardener API / CRDs to obtain the faulty instance identifier in a cloud-agnostic way.</p><p>Gardener uses the <a href=https://github.com/gardener/machine-controller-manager>Machine Controller Manager</a> to create the Shoot worker nodes.
For each worker node, the Machine Controller Manager creates a <code>Machine</code> CRD in the Shoot namespace in the respective <code>Seed</code> cluster.
Usually the problematic instance can be identified as the respective <code>Machine</code> CRD has status <code>pending</code>.</p><p>The instance / node name can be obtained from the <code>Machine</code> <code>.status</code> field:</p><pre><code>$ kubectl get machine &lt;machine-name&gt; -o json | jq -r .status.node
</code></pre><p>This is all the information needed to go ahead and use <code>gardenctl ssh</code> to get a shell to the node.
In addition, the used cloud provider, the specific identifier of the instance and the instance region can be identified from the <code>Machine</code> CRD.</p><p>Get the identifier of the instance via:</p><pre><code>$ kubectl get machine &lt;machine-name&gt; -o json | jq -r .spec.providerID // e.g aws:///eu-north-1/i-069733c435bdb4640
</code></pre><p>The identifier shows that the instance belongs to the cloud provider <code>aws</code> with the ec2 instance-id <code>i-069733c435bdb4640</code> in region <code>eu-north-1</code>.</p><p>To get more information about the instance, check out the <code>MachineClass</code> (e.g <code>AWSMachineClass</code>) that is associated with each <code>Machine</code> CRD in the <code>Shoot</code> namespace of the <code>Seed</code> cluster.
The <code>AWSMachineClass</code> contains the machine image (<a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html>ami</a>), machine-type, iam information, network-interfaces, subnets, security groups and attached volumes.</p><p>Of course, the information can also be used to get the instance with the cloud provider CLI / API.</p><h2 id=gardenctl-ssh>gardenctl ssh</h2><p>Using the node name of the problematic instance, we can use the <code>gardenctl ssh</code> command to get SSH access to the cloud provider
instance via an automatically set up <a href=https://en.wikipedia.org/wiki/Bastion_host>bastion host</a>.
<code>gardenctl</code> takes care of spinning up the <code>bastion</code> instance, setting up the SSH keys, ports and security groups and opens a root shell on the target instance.
After the SSH session has ended, <code>gardenctl</code> deletes the created cloud provider resources.</p><p>Use the following commands:</p><p>First, target a Garden cluster containing all the Shoot definitions.</p><pre><code>$ gardenctl target garden &lt;target-garden&gt;
</code></pre><p>Target an available Shoot by name.
This sets up the context, configures the <code>kubeconfig</code> file of the Shoot cluster and downloads the cloud provider credentials.
Subsequent commands will execute in this context.</p><pre><code>$ gardenctl target shoot &lt;target-shoot&gt;
</code></pre><p>This uses the cloud provider credentials to spin up the bastion and to open a shell on the target instance.</p><pre><code>$ gardenctl ssh &lt;target-node&gt;
</code></pre><h2 id=ssh-with-manually-created-bastion-on-aws>SSH with manually created Bastion on AWS</h2><p>In case you are not using <code>gardenctl</code> or want to control the bastion instance yourself, you can also manually set it up.
The steps described here are generally the same as <a href=https://github.com/gardener/gardenctl/blob/10a537942b94234914758c0f6d053dc1cf218ecd/pkg/cmd/ssh_aws.go#L53-L52>those used by <code>gardenctl</code> internally</a>.
Despite some cloud provider specifics they can be generalized to the following list:</p><ul><li>Open port 22 on the target instance.</li><li>Create an instance / VM in a public subnet (bastion instance needs to have public ip address).</li><li>Set-up security groups, roles and open port 22 for the bastion instance.</li></ul><p>The following diagram shows an overview how the SSH access to the target instance works:</p><img style=margin-left:0 alt="SSH Bastion diagram" src=resources/913441003e5641bc90249bdc07d55656.png><br><p>This guide demonstrates the setup of a bastion on AWS.</p><p><strong>Prerequisites:</strong></p><ul><li>The <code>AWS CLI</code> is set up.</li><li>Obtain target instance-id (see <a href=#identifying-the-problematic-instance>here</a>).</li><li>Obtain the VPC ID the Shoot resources are created in. This can be found in the <code>Infrastructure</code> CRD in the <code>Shoot</code> namespace in the <code>Seed</code>.</li><li>Make sure that port 22 on the target instance is open (default for Gardener deployed instances).<ul><li>Extract security group via</li></ul><pre><code>$ aws ec2 describe-instances --instance-ids &lt;instance-id&gt;
</code></pre><ul><li>Check for rule that allows inbound connections on port 22:</li></ul><pre><code>$ aws ec2 describe-security-groups --group-ids=&lt;security-group-id&gt;
</code></pre><ul><li>If not available, create the rule with the following comamnd:</li></ul><pre><code>$ aws ec2 authorize-security-group-ingress --group-id &lt;security-group-id&gt;  --protocol tcp --port 22 --cidr 0.0.0.0/0
</code></pre></li></ul><h3 id=create-the-bastion-security-group>Create the Bastion Security Group</h3><ul><li><p>The common name of the security group is <code>&lt;shoot-name>-bsg</code>. Create the security group:</p><pre><code>$ aws ec2 create-security-group --group-name &lt;bastion-security-group-name&gt;  --description ssh-access --vpc-id &lt;VPC-ID&gt;
</code></pre></li><li><p>Optionally, create identifying tags for the security group:</p><pre><code>$ aws ec2 create-tags --resources &lt;bastion-security-group-id&gt; --tags Key=component,Value=&lt;tag&gt;
</code></pre></li><li><p>Create permission in the bastion security group that allows ssh access on port 22.</p><pre><code>$ aws ec2 authorize-security-group-ingress --group-id &lt;bastion-security-group-id&gt;  --protocol tcp --port 22 --cidr 0.0.0.0/0
</code></pre></li><li><p>Create an IAM role for the bastion instance with the name <code>&lt;shoot-name>-bastions</code>:</p><pre><code>$ aws iam create-role --role-name &lt;shoot-name&gt;-bastions
</code></pre><p>The content should be:</p></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
<span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
<span style=color:#f92672>&#34;Statement&#34;</span>: [
    {
        <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
        <span style=color:#f92672>&#34;Action&#34;</span>: [
            <span style=color:#e6db74>&#34;ec2:DescribeRegions&#34;</span>
        ],
        <span style=color:#f92672>&#34;Resource&#34;</span>: [
            <span style=color:#e6db74>&#34;*&#34;</span>
        ]
    }
]
}
</code></pre></div><ul><li><p>Create the instance profile with name <code>&lt;shoot-name>-bastions</code>:</p><pre><code>$ aws iam create-instance-profile --instance-profile-name &lt;name&gt;
</code></pre></li><li><p>Add the created role to the instance profile:</p><pre><code>$ aws iam add-role-to-instance-profile --instance-profile-name &lt;instance-profile-name&gt; --role-name &lt;role-name&gt;
</code></pre></li></ul><h3 id=create-the-bastion-instance>Create the bastion instance</h3><p>Next, in order to be able to <code>ssh</code> into the bastion instance, the instance has to be set up with a user with a public ssh key.
Create a user <code>gardener</code> that has the same Gardener-generated public ssh key as the target instance.</p><ul><li><p>First, we need to get the public part of the <code>Shoot</code> ssh-key.
The ssh-key is stored in a secret in the the project namespace in the Garden cluster.
The name is: <code>&lt;shoot-name>-ssh-publickey</code>.
Get the key via:</p><pre><code>$ kubectl get secret aws-gvisor.ssh-keypair -o json | jq -r .data.\&quot;id_rsa.pub\&quot;
</code></pre></li><li><p>A script handed over as <code>user-data</code> to the bastion <code>ec2</code> instance, can be used to create the <code>gardener</code> user and add the ssh-key.
For your convenience, you can use the following script to generate the <code>user-data</code>.</p></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash -eu
</span><span style=color:#75715e></span>saveUserDataFile <span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
  ssh_key<span style=color:#f92672>=</span>$1

cat &gt; gardener-bastion-userdata.sh <span style=color:#e6db74>&lt;&lt;EOF
</span><span style=color:#e6db74>#!/bin/bash -eu
</span><span style=color:#e6db74>id gardener || useradd gardener -mU
</span><span style=color:#e6db74>mkdir -p /home/gardener/.ssh
</span><span style=color:#e6db74>echo &#34;$ssh_key&#34; &gt; /home/gardener/.ssh/authorized_keys
</span><span style=color:#e6db74>chown gardener:gardener /home/gardener/.ssh/authorized_keys
</span><span style=color:#e6db74>echo &#34;gardener ALL=(ALL) NOPASSWD:ALL&#34; &gt;/etc/sudoers.d/99-gardener-user
</span><span style=color:#e6db74>EOF</span>
<span style=color:#f92672>}</span>


<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -p /dev/stdin <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
    read -r input
    cat | saveUserDataFile <span style=color:#e6db74>&#34;</span>$input<span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>else</span>
    pbpaste | saveUserDataFile <span style=color:#e6db74>&#34;</span>$input<span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>fi</span>
</code></pre></div><ul><li><p>Use the script by handing-over the public ssh-key of the <code>Shoot</code> cluster:</p><pre><code>$ kubectl get secret aws-gvisor.ssh-keypair -o json | jq -r .data.\&quot;id_rsa.pub\&quot; | ./generate-userdata.sh
</code></pre><p>This generates a file called <code>gardener-bastion-userdata.sh</code> in the same directory containing the <code>user-data</code>.</p></li><li><p>The following information is needed to create the bastion instance:</p><p><code>bastion-IAM-instance-profile-name</code></p><ul><li>Use the created instance profile with name <code>&lt;shoot-name>-bastions</code></li></ul><p><code>image-id</code></p><ul><li>Possible use the same image-id as for the target instance (or any other image). Has cloud provider specific format (AWS: <code>ami</code>).</li></ul><p><code>ssh-public-key-name</code></p><ul><li>This is the ssh key pair already created in the Shoot&rsquo;s cloud provider account by Gardener during the <code>Infrastructure</code> CRD reconciliation.</li><li>The name is usually: <code>&lt;shoot-name>-ssh-publickey</code></li></ul><p><code>subnet-id</code></p><ul><li>Choose a subnet that is attached to an <code>Internet Gateway</code> and <code>NAT Gateway</code> (bastion instance must have a public IP).</li><li>The Gardener created public subnet with the name <code>&lt;shoot-name>-public-utility-&lt;xy></code> can be used.
Please check the created subnets with the cloud provider.</li></ul><p><code>bastion-security-group-id</code></p><ul><li>Use the id of the created bastion security group.</li></ul><p><code>file-path-to-userdata</code></p><ul><li><p>Use the filepath to <code>user-data</code> file generated in the previous step.</p></li><li><p><code>bastion-instance-name</code></p><ul><li>Optional to tag the instance.</li><li>Usually <code>&lt;shoot-name>-bastions</code></li></ul></li></ul></li><li><p>Create the bastion instance via:</p></li></ul><pre><code>$ ec2 run-instances --iam-instance-profile Name=&lt;bastion-IAM-instance-profile-name&gt; --image-id &lt;image-id&gt;  --count 1 --instance-type t3.nano --key-name &lt;ssh-public-key-name&gt;  --security-group-ids &lt;bastion-security-group-id&gt; --subnet-id &lt;subnet-id&gt; --associate-public-ip-address --user-data &lt;file-path-to-userdata&gt; --tag-specifications ResourceType=instance,Tags=[{Key=Name,Value=&lt;bastion-instance-name&gt;},{Key=component,Value=&lt;mytag&gt;}] ResourceType=volume,Tags=[{Key=component,Value=&lt;mytag&gt;}]&quot;
</code></pre><p>Capture the <code>instance-id</code> from the reponse and wait until the <code>ec2</code> instance is running and has a public ip address.</p><h2 id=connecting-to-the-target-instance>Connecting to the target instance</h2><p>Save the private key of the ssh-key-pair in a temporary local file for later use.</p><pre><code>$ umask 077

$ kubectl get secret &lt;shoot-name&gt;.ssh-keypair -o json | jq -r .data.\&quot;id_rsa\&quot; | base64 -d &gt; id_rsa.key
</code></pre><p>Use the private ssh key to ssh into the bastion instance.</p><pre><code>$ ssh -i &lt;path-to-private-key&gt; gardener@&lt;public-bastion-instance-ip&gt; 
</code></pre><p>If that works, connect from your local terminal to the target instance via the bastion.</p><pre><code>$ ssh  -i &lt;path-to-private-key&gt; -o ProxyCommand=&quot;ssh -W %h:%p -i &lt;private-key&gt; -o IdentitiesOnly=yes -o StrictHostKeyChecking=no gardener@&lt;public-ip-bastion&gt;&quot; gardener@&lt;private-ip-target-instance&gt; -o IdentitiesOnly=yes -o StrictHostKeyChecking=no
</code></pre><h2 id=cleanup>Cleanup</h2><p>Do not forget to cleanup the created resources. Otherwise Gardener will eventually fail to delete the Shoot.</p><footer class=footline></footer></div></div><div class=howto_tickets><span class=open_github_ticket><h3 class=open_github_ticket_header><img src=https://gardener.cloud/images/branding/github.svg> Report an issue</h3>See a typo? Have a picture to recommend? Want to edit some words/phrases/sentences?
You can simply submit a ticket to request we make the change. If you are github savvy, submit a
pull request.
<a href=# onclick="return createIssue('https:\/\/github.com\/gardener\/documentation\/issues/new','documentation\/050-tutorials\/content\/howto\/shell-to-node\/_index.md','https:\/\/github.com\/gardener\/documentation\/edit\/master\/website\/documentation\/050-tutorials\/content\/howto\/shell-to-node\/_index.md')" target=_blank>Open Github Issue <i class="fa fa-external-link" aria-hidden=true></i></a><br></span></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1589917624></script><script src=/js/perfect-scrollbar.min.js?1589917624></script><script src=/js/perfect-scrollbar.jquery.min.js?1589917624></script><script src=/js/jquery.sticky.js?1589917624></script><script src=/js/featherlight.min.js?1589917624></script><script src=/js/html5shiv-printshiv.min.js?1589917624></script><script src=/js/highlight.pack.js?1589917624></script><script>hljs.initHighlightingOnLoad();</script><script src=/js/modernizr.custom.71422.js?1589917624></script><script src=/js/learn.js?1589917624></script><script src=/js/hugo-learn.js?1589917624></script><link href=/mermaid/mermaid.css?1589917624 type=text/css rel=stylesheet><script src=/mermaid/mermaid.js?1589917624></script><script>mermaid.initialize({startOnLoad:true,htmlLables:true});function createIssue(issueUrl,page,url){var uri=issueUrl+"?title=Documentation issue on page \""+page+"\"";uri=uri+"&body=\n\n<- DESCRIBE MISSING OR FAULTY DOCUMENTATION HERE->\n\n---\nPage: ["+page+"]("+
url+")\ndon't remove the link to the page. It's required for the processor"
var res=encodeURI(uri);res+="&labels=area/documentation"
window.open(res,"issue")
return false;}
$(document).ready(function(){var $window=$(window);$window.sr=ScrollReveal({reset:false});$window.sr.reveal('.reveal-fast',{duration:2000});$window.sr.reveal('.reveal-slow',{duration:2500});$window.sr.reveal('.reveal-right',{duration:2000,origin:'right',distance:'300px'});$window.sr.reveal('.reveal-left',{duration:2000,origin:'left',distance:'300px'});inlineSVG.init();});</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W2FGNSX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>function setMenuHeight(){$('#sidebar .highlightable').height($('#sidebar').innerHeight()-$('#header-wrapper').height()-40);$('#sidebar .highlightable').perfectScrollbar('update');var $blockList=$('#sidebar .highlightable');if($blockList.length&&window.localStorage){var position=localStorage.getItem('blockListScrollPosition');if(position){$blockList.scrollTop(position);}
$(window).on('unload',function(){var scrollPosition=$blockList.scrollTop();localStorage.setItem('blockListScrollPosition',scrollPosition);});}}
(function(){$("#body-inner a").not(".inline").each(function(){if(this.hostname!=window.location.hostname&&this.href.indexOf("mailto:")===-1){this.target='_blank';$(this).addClass("externalLink");if($(this).find("img").length===0){this.innerHTML+='<i class="fa fa-external-link" aria-hidden="true"></i>';}}});})();</script></body></html>