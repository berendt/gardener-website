<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Project Gardener Website - A Managed Kubernetes Service Done Right"><meta name=copyright content="Copyright 2019 Gardener project authors."><meta name=google-site-verification content="9EoGiMwk2aq0E_tVh16iJgJbp7fbyqkfWH9b5sGybl0"><title>Machine Controller Manager :: Gardener</title><link rel=icon type=image/x-icon href=https://gardener.cloud/images/favicon.ico><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://gardener.cloud/images/favicon-16x16.png sizes=16x16><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-W2FGNSX');</script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-165447164-1');</script><link href=/css/nucleus.css?1611676101 rel=stylesheet><link href=/css/font-awesome.min.css?1611676101 rel=stylesheet><link href=/css/hybrid.css?1611676101 rel=stylesheet><link href=/css/featherlight.min.css?1611676101 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1611676101 rel=stylesheet><link href=/css/auto-complete.css?1611676101 rel=stylesheet><link href=/css/skeleton.css?1611676101 rel=stylesheet><link href=/css/sheetslider.css?1611676101 rel=stylesheet><link rel=stylesheet href=/css/gardener.e2ca9959244349715932e2bbb82ec914af6743c4148bb41946b0aea714f04a0d.css><script src=/js/moment.js?1611676101></script><script src=/js/vivus.js?1611676101></script><script src=/js/scrollreveal.js?1611676101></script><script src=/js/inlineSVG.js?1611676101></script><script src=/js/jquery.min.js?1611676101></script><script src=/js/fixed.js?1611676101></script><script src=/js/clipboard.min.js?1611676101></script><script src=https://platform.linkedin.com/in.js type=text/javascript>lang:en_US</script></head><body data-url=/blog/2021-01/00/ class=has-sticky-navigation><script>$(document).ready(function(){function initStickyNav(){var stickyPoint;var tln=document.querySelector(".tln");if(!tln){return;}
var stickyPointEl=document.querySelector(".sticky-nav-point");if(stickyPointEl==null){stickyPointEl=document.querySelector("body");stickyPoint=0;}else{stickyPoint=stickyPointEl.clientHeight+stickyPointEl.offsetTop;}
var bodySelector=document.getElementsByTagName("body")[0];var tlnHeight=tln.clientHeight;var stickyNavigation=function(){if(window.pageYOffset+tlnHeight>=stickyPoint){bodySelector.classList.add("has-sticky-navigation");tln.classList.add("sticky-top");}else{bodySelector.classList.remove("has-sticky-navigation");tln.classList.remove("sticky-top");}}
window.onscroll=function(){stickyNavigation();};}
initStickyNav();function closeAllSelect(){document.getElementById("docOptions").classList.remove("show");}
function show(e){e.stopPropagation();document.getElementById("docOptions").classList.add("show");}
document.addEventListener("click",closeAllSelect);document.getElementById("docSelector").addEventListener("click",show);});</script><div class="tln fixedsticky sticky-top"><header class=navigation><div class=container><div class=navigation-wrapper><a href=/ class=logo><img src=/images/logo.svg>
<span class=title>Gardener</span></a>
<a class="nav-button navbar-toggler" href=#><i class="fa fa-bars"></i></a><div class=navbar-collapse><ul class=links><li class="link active"><a href=/blog/>Blogs</a></li><li class=link><a href=/community/>Community</a></li><li class=link><a href=/adopter/>Adopters</a></li><li class="link has-child"><a href=/documentation/home>Documentation</a></li></ul></div></div></div></header></div><script>$(".navigation .navbar-toggler").click(function(evt){$(".navigation .navbar-collapse").toggle();$(".navigation").toggleClass("collapsed");$(".navigation .search-box").toggle();})</script><style>#docSelector{cursor:pointer}.doc-options{position:fixed;background-color:#0b8062;text-align:left;display:none}.doc-options ul li{margin-bottom:0}.doc-options ul li a:hover{background-color:#0c694f}.doc-options ul{list-style:none;padding:0;margin:0;text-align:left}.doc-options ul li a{padding:10px;margin:0}.doc-options .activeVersion{background-color:#ec682a}.show{display:block}</style><div class="main container"><section><div class="highlightable body-inner-wrapper"><div id=body-inner><script src=/js/moment.js></script><div class="blogs page"><a href=/blog class="nav-link back">Back to Blogs</a><article class="post row" data-path><div class=wrapper><div class="two columns"><ul class=authors><li class=author><a href=mailto:samarth.deyagond@sap.com><img src="https://avatars.githubusercontent.com/u/32246441?s=460&u=2e611ee3c06533c3ec9d73e0557bab1432446657&v=4" class="user-icon icons" alt="blog author avatar">
<span class=name>Samarth S Deyagond</span></a></li></ul><span class=publishdate data-publishdate=2021-01-25>2021-01-25</span></div><div class="ten columns"><h2>Machine Controller Manager<a href=/blog/2021-01/00/ class="title-link clipboard-copy"><i class="fa fa-link"></i></a></h2><div class=share-ribbon><a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class=twitter-share-button data-text="Machine Controller Manager" data-url=https://gardener.cloud/blog/2021-01/00/ data-hashtags=GardenerProject data-dnt=true data-show-count=false>Tweet</a><script async src=https://platform.twitter.com/widgets.js></script>
<script type=in/share data-url=https://gardener.cloud/blog/2021-01/00/></script></div><p><p>Kubernetes is a cloud-native enabler built around the principles for a resilient, manageable, observable, highly automated, loosely coupled system. We know that Kubernetes is infrastructure agnostic. So, it would be very convenient for the enterprises that run these K8s clusters, if:</p><ul><li>they can seamlessly manage the underlying machines that act as K8s nodes.</li><li>they can manage their K8s clusters on different cloud providers.</li><li>they can seamlessly scale and upgrade the cluster at their will.</li></ul><p>This declarative management of machines just like another K8s resource of a K8s cluster is brought to you by <a href=https://github.com/gardener/machine-controller-manager>Machine Controller Manager</a> (aka MCM), which, of course, is an open sourced project.</p><h2 id=machine-controller-manager-aka-mcm>Machine Controller Manager aka MCM</h2><p><a href=https://github.com/gardener/machine-controller-manager>Machine Controller Manager</a> is a group of cooperative controllers that manage the lifecycle of the worker machines. It is inspired by the design of Kube Controller Manager in which various sub controllers manage their respective Kubernetes Clients.</p><p>Machine Controller Manager reconciles a set of Custom Resources namely <code>MachineDeployment</code>, <code>MachineSet</code> and <code>Machines</code> which are managed & monitored by their controllers <code>MachineDeployment Controller</code>, <code>MachineSet Controller</code>, <code>Machine Controller</code> respectively along with another cooperative controller called the <code>Safety Controller</code>.</p><h2 id=understanding-the-sub-controllers-and-custom-resources-of-mcm>Understanding the sub-controllers and Custom Resources of MCM</h2><p>The Custom Resources <code>MachineDeployment</code>, <code>MachineSet</code> and <code>Machines</code> are very much analogous to the native K8s resources of <code>Deployment</code>, <code>ReplicaSet</code> and <code>Pods</code> respectively. So, in the context of MCM:</p><ul><li><code>MachineDeployment</code> provides a declarative update for <code>MachineSet</code> and <code>Machines</code>. <code>MachineDeployment Controller</code> reconciles the <code>MachineDeployment</code> objects and manages the lifecycle of <code>MachineSet</code> objects. <code>MachineDeployment</code> consumes provider specific <code>MachineClass</code> in its <code>spec.template.spec</code> which is the template of the VM spec that would be spawned on the cloud by MCM.</li><li><code>MachineSet</code> ensures that the specified number of <code>Machine</code> replicas are running at a given point of time. <code>MachineSet Controller</code> reconciles the <code>MachineSet</code> objects and manages the lifecycle of <code>Machine</code> objects.</li><li><code>Machines</code> are the actual VMs running on the cloud platform provided by one of the supported cloud providers. <code>Machine Controller</code> is the controller that actually communicates with the cloud provider to create/update/delete machines on the cloud.</li><li>There is a <code>Safety Controller</code> responsible for handling the unidentified or unknown behaviours from the cloud providers.</li><li>Along with the above Custom Controllers and Resources, MCM requires the <code>MachineClass</code> to use K8s <code>Secret</code> that stores cloudconfig (initialization scripts used to create VMs) and cloud specific credentials.</li></ul><p> </p><h2 id=working-of-mcm>Working of MCM</h2><p><img title="Figure 1: In-Tree Machine Controller Manager" src=../../../../__resources/180665a7-6e28-408a-aff8-b139aa6a6234.png style=width:90%;height:auto></p><figcaption style=text-align:center;margin-top:0;margin-bottom:30px;font-size:90%>Figure 1: In-Tree Machine Controller Manager</figcaption><p>In MCM, there are two K8s clusters in the scope — a <em>Control Cluster</em> and a <em>Target Cluster</em>. Control Cluster is the K8s cluster where the MCM is installed to manage the machine lifecycle of the Target Cluster. In other words, Control Cluster is the one where the machine-* objects are stored. Target Cluster is where all the node objects are registered. These clusters can be two distinct clusters or the same cluster, whichever fits.</p><p>When a <code>MachineDeployment</code> object is created, <code>MachineDeployment Controller</code> creates the corresponding <code>MachineSet</code> object. The <code>MachineSet Controller</code> in-turn creates the <code>Machine</code> objects. The <code>Machine Controller</code> then talks to the cloud provider API and actually creates the VMs on the cloud.</p><p>The cloud initialization script that is introduced into the VMs via the K8s <code>Secret</code> consumed by the <code>MachineClasses</code> talks to the KCM (K8s Controller Manager) and creates the node objects. Nodes after registering themselves to the Target Cluster, start sending health signals to the machine objects. That is when MCM updates the status of the machine object from <code>Pending</code> to <code>Running</code>.
 </p><h2 id=more-on-safety-controller>More on Safety Controller</h2><p>Safety Controller contains following functions:</p><p><strong>Orphan VM handling</strong>:</p><ul><li>It lists all the VMs in the cloud; matching the tag of given cluster name and maps the VMs with the <code>Machine</code> objects using the <code>ProviderID</code> field. VMs without any backing <code>Machine</code> objects are logged and deleted after confirmation.</li><li>This handler runs every 30 minutes and is configurable via <code>--machine-safety-orphan-vms-period</code> flag.</li></ul><p><strong>Freeze mechanism</strong>:</p><ul><li><code>Safety Controller</code> freezes the <code>MachineDeployment</code> and <code>MachineSet controller</code> if the number of <code>Machine</code> objects goes beyond a certain threshold on top of <code>Spec.Replicas</code>. It can be configured by the flag <code>--safety-up</code> or <code>--safety-down</code> and also <code>--machine-safety-overshooting-period</code>.</li><li><code>Safety Controller</code> freezes the functionality of the MCM if either of the <code>target-apiserver</code> or the <code>control-apiserver</code> is not reachable.</li><li><code>Safety Controller</code> unfreezes the MCM automatically once situation is resolved to normal. A <code>freeze</code> label is applied on <code>MachineDeployment</code>/<code>MachineSet</code> to enforce the freeze condition.</li></ul><h2 id=evolution-of-mcm-from-in-tree-to-out-of-tree-oot>Evolution of MCM from In-Tree to Out-of-Tree (OOT)</h2><p>MCM supports declarative management of machines in a K8s Cluster on various cloud providers like AWS, Azure, GCP, AliCloud, OpenStack, Metal-stack, Packet, KubeVirt, VMWare, Yandex. It can, of course, be easily extended to support other cloud providers.</p><p>Going ahead having the implementation of the Machine Controller Manager supporting too many cloud providers would be too much upkeep from both a development and a maintenance point of view. Which is why, the <code>Machine Controller</code> component of MCM has been moved to Out-of-Tree design where <code>Machine Controller</code> for respective cloud provider runs as an independent executable; even though typically packaged under the same deployment.</p><p><img title="Figure 2: Out-Of-Tree Machine Controller Manager" src=../../../../__resources/f86654eb-b738-4b77-858c-b6e1af05290d.png style=width:90%;height:auto></p><figcaption style=text-align:center;margin-top:0;margin-bottom:30px;font-size:90%>Figure 2: Out-Of-Tree (OOT) Machine Controller Manager</figcaption><p>This OOT Machine Controller will implement a common interface to manage the VMs on the respective cloud provider. Now, while <code>Machine Controller</code> deals with the <code>Machine</code> objects, Machine Controller Manager (MCM) deals with higher level objects such as <code>MachineSet</code> and <code>MachineDeployment</code> objects.</p><h2 id=who-uses-mcm>Who uses MCM?</h2><p><strong><a href=http://gardener.cloud>Gardener</a></strong></p><p>MCM is originally developed and employed by a K8s Control Plane as a Service called Gardener. However, the MCM’s design is elegant enough to be employed when managing the machines of any independent K8s clusters, without having to necessarily associate it with Gardener.</p><p><strong><a href=http://sky.com>Sky UK Limited</a></strong></p><p>Sky UK Limited is a British broadcaster and telecommunications company in UK who recently migrated their Kubernetes nodes from Ansible to Machine Controller Manager. Check out <a href=https://youtu.be/yF4wq7GAeEM>this</a> video from YouTube <a href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw>Gardener Project</a> Channel where Anthony Comtios, Principle Engineer working at Sky talks about MCM in action with Sky&rsquo;s tech stack.</p><h2 id=conclusion>Conclusion</h2><p>Machine Controller Manager is so far the best automation for machine management for K8s Clusters. And the best part is that it is open sourced. It gives everyone a scope of both employment and enhancement at ease.</p><p>Whether you want to know more about Machine Controller Manager or see a potential scope of the same for your solutions, then visit the GitHub page <a href=https://github.com/gardener/machine-controller-manager>machine-controller-manager</a>. We are so excited to see what you achieve with Machine Controller Manager.</p></p></div></div></article><a href=/blog class="nav-link back">Back to Blogs</a></div></div></div></section></div><style></style><footer class=footer><div class="container footer-wrapper"><ul class=nav><li><a href=/blog/>Blogs</a></li><li><a href=/community/>Community</a></li><li><a href=/adopter/>Adopters</a></li><li><a href=/documentation/home>Documentation</a></li></ul><img src=/images/lp/gardener-logo.svg alt="Logo Gardener" class=logo><ul class=media-wr><li><a target=_blank href=https://kubernetes.slack.com/archives/CB57N0BFG><img src=/images/branding/slack-logo-white.svg class=media-icon><div class=media-text>Slack</div></a></li><li><a target=_blank href=https://github.com/gardener><img src=/images/branding/github-mark-logo.png class=media-icon><div class=media-text>GitHub</div></a></li><li><a target=_blank href=https://www.youtube.com/channel/UCwUhwKFREV8Su0gwAJQX7tw><img src=/images/branding/youtube-logo-dark.svg class=media-icon><div class=media-text>YouTube</div></a></li><li><a target=_blank href=https://twitter.com/GardenerProject><img src=/images/branding/twitter-logo-white.svg class=media-icon><div class=media-text>Twitter</div></a></li></ul><span class=copyright>Copyright 2020 Gardener project authors. Privacy Statement</span></div></footer><script src=/js/perfect-scrollbar.min.js?1611676101></script><script src=/js/perfect-scrollbar.jquery.min.js?1611676101></script><script src=/js/jquery.sticky.js?1611676101></script><script src=/js/featherlight.min.js?1611676101></script><script src=/js/html5shiv-printshiv.min.js?1611676101></script><script src=/js/modernizr.custom.71422.js?1611676101></script><link href=/mermaid/mermaid.css?1611676101 type=text/css rel=stylesheet><script src=/mermaid/mermaid.js?1611676101></script><script src=/js/code-snippets.js?1611676101></script><script>mermaid.initialize({startOnLoad:true,htmlLables:true});function createIssue(issueUrl,page,url){var uri=issueUrl+"?title=Documentation issue on page \""+page+"\"";uri=uri+"&body=\n\n<- DESCRIBE MISSING OR FAULTY DOCUMENTATION HERE->\n\n---\nPage: ["+page+"]("+
url+")\ndon't remove the link to the page. It's required for the processor"
var res=encodeURI(uri);res+="&labels=area/documentation"
window.open(res,"issue")
return false;}
$(document).ready(function(){inlineSVG.init();$("[data-publishdate]").each(function(){$(this).text(moment($(this,"YYYY-MM-DD","YYYY-MM-DD hh:mm:ss").attr("data-publishdate")).fromNow());});new ClipboardJS('.clipboard-copy');$("body").codeSnippets();});</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W2FGNSX" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script src=/js/modernizr.custom.min.js></script><script src=/js/jsrender.min.js></script><script src=/js/main.js></script><script>$(document).ready(function(){$('.blogs .clipboard-copy').click(function(e){e.preventDefault();});})</script></body></html>